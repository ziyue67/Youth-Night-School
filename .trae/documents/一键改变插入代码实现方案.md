## 目标
- 提供一键按钮集成，点击后自动查询资源包额度、拉起授权、服务端消费 code 获取手机号并完成扣费。
- 前端可自定义欠费提示；后端按新接口方式（基础库≥2.21.2）安全消费。

## 前端改动
- 在页面插入组件：设置 `open-type="getPhoneNumber"`、绑定 `bindgetphonenumber`、关闭默认欠费提示以便自定义。
```wxml
<button open-type="getPhoneNumber" bindgetphonenumber="onGetPhoneNumber" phone-number-no-quota-toast="{{false}}">一键获取手机号</button>
```
- 事件处理：
```js
Page({
  onGetPhoneNumber(e) {
    if (e.detail && e.detail.errno === 1400001) {
      wx.showToast({ title: '当前额度不足', icon: 'none' })
      return
    }
    if (e.detail && e.detail.errMsg === 'getPhoneNumber:ok' && e.detail.code) {
      wx.request({
        url: 'https://your.server/phone/consume',
        method: 'POST',
        data: { code: e.detail.code },
        success: res => {
          const phoneNumber = res.data.phoneNumber
          wx.showToast({ title: '获取成功', icon: 'none' })
        },
        fail: () => {
          wx.showToast({ title: '服务端异常', icon: 'none' })
        }
      })
    } else {
      wx.showToast({ title: '未授权手机号', icon: 'none' })
    }
  }
})
```

## 后端接口
- 新增 `POST /phone/consume`，接收 `code`，在 5 分钟有效期内调用微信接口消费一次。
- 获取 `ACCESS_TOKEN`：`client_credential`（按 `appid/secret`）。
- 调用微信：`POST https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=ACCESS_TOKEN`，请求体 `{ code }`。
```js
const axios = require('axios')
async function fetchAccessToken(appid, secret) {
  const url = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${appid}&secret=${secret}`
  const { data } = await axios.get(url)
  if (data.access_token) return data.access_token
  throw new Error(`${data.errcode}:${data.errmsg}`)
}
async function getPhoneNumber(accessToken, code) {
  const url = `https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=${accessToken}`
  const { data } = await axios.post(url, { code })
  if (data.errcode === 0) return data.phone_info.phoneNumber
  throw new Error(`${data.errcode}:${data.errmsg}`)
}
```

## 配置与安全
- 环境变量管理 `APPID/SECRET`；`ACCESS_TOKEN` 缓存与过期刷新。
- 防重放：对同一 `code` 做幂等校验；记录消费状态。
- 限流与来源校验：校验小程序请求签名/来源域名；开启服务端限流。

## 兼容与容错
- 统一错误码映射与前端提示；对 `code` 过期、额度不足、接口异常分别兜底。
- 可选兼容基础库<2.21.2 的旧方案（加密数据+session_key）作为降级路径。

## 联调与验证
- 真机调试：验证正常授权、额度不足、拒绝授权三种路径。
- 模拟服务端错误与 `code` 过期场景；日志采集与埋点。
- 验证每次点击仅消费一次 `code`；检查扣费与额度扣减一致性。

## 交付内容
- 页面按钮与事件处理代码片段。
- 服务端获取手机号函数与路由示例。
- 环境变量与配置示例，联调测试用例清单。